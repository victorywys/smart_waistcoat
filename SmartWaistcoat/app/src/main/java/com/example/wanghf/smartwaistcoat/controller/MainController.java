package com.example.wanghf.smartwaistcoat.controller;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.net.Uri;
import android.os.Environment;
import android.preference.PreferenceManager;
import android.util.Log;

import com.example.wanghf.smartwaistcoat.inputdata.WaistcoatData;
import com.example.wanghf.smartwaistcoat.utils.BroadcastUtil;
import com.example.wanghf.smartwaistcoat.utils.FileUtil;
import com.example.wanghf.smartwaistcoat.widget.EcgView;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.Properties;
import java.util.concurrent.LinkedBlockingQueue;

/**
 * Created by wanghf on 2017/4/17.
 */

public class MainController {
    private static final String TAG = "MainController";

    private Context context;
    private LinkedBlockingQueue ecgQueue;
    private LinkedBlockingQueue spoQueue;
    private LinkedBlockingQueue gsenQueue;
    private List<Integer> spoList;
    private List<Integer> ecgList;
    private List<Integer> gsenList;
    private List<Integer> ecgListEx;
    private String source;
    private ControllerThread controllerThread;

    private boolean filterOn;

    private FileUtil fileUtil = new FileUtil();

    private double[] ecgPrea = new double[] {1,1.55331262919990,0.9216};
    private double[] ecgPreb = new double[] {1,1.61803398874989,1};

    private double[] ecgb = new double[]{
            0.0314627754884703,0.0309931911843689,0.0305273616575497,0.0300652737333556,0.0296069142371294,0.0291522699942140,0.0287013278299523,0.0282540745696871,0.0278104970387613,0.0273705820625177,0.0269343164662993,0.0265016870754490,0.0260726807153094,0.0256472842112237,0.0252254843885345,0.0248072680725849,0.0243926220887176,0.0239815332622755,0.0235739884186016,0.0231699743830386,0.0227694779809294,0.0223724860376169,0.0219789853784440,0.0215889628287536,0.0212024052138885,0.0208192993591915,0.0204396320900056,0.0200633902316736,0.0196905606095385,0.0193211300489429,0.0189550853752299,0.0185924134137424,0.0182331009898230,0.0178771349288149,0.0175245020560607,0.0171751891969034,0.0168291831766859,0.0164864708207509,0.0161470389544415,0.0158108744031004,0.0154779639920706,0.0151482945466948,0.0148218528923160,0.0144986258542770,0.0141786002579208,0.0138617629285901,0.0135481006916279,0.0132376003723769,0.0129302487961802,0.0126260327883805,0.0123249391743207,0.0120269547793437,0.0117320664287924,0.0114402609480096,0.0111515251623383,0.0108658458971211,0.0105832099777012,0.0103036042294212,0.0100270154776241,0.00975343054765273,0.00948283626485000,0.00921521945455876,0.00895056694212187,0.00868886555288220,0.00843010211218264,0.00817426344536603,0.00792133637777526,0.00767130773475319,0.00742416434164270,0.00717989302378665,0.00693848060652791,0.00669991391520935,0.00646417977517385,0.00623126501176426,0.00600115645032346,0.00577384091619433,0.00554930523471972,0.00532753623124251,0.00510852073110557,0.00489224555965177,0.00467869754222398,0.00446786350416506,0.00425973027081789,0.00405428466752533,0.00385151351963026,0.00365140365247555,0.00345394189140406,0.00325911506175866,0.00306690998888223,0.00287731349811763,0.00269031241480773,0.00250589356429541,0.00232404377192352,0.00214474986303495,0.00196799866297256,0.00179377699707922,0.00162207169069780,0.00145286956917117,0.00128615745784220,0.00112192218205375,0.000960150567148707,0.000800829438469930,0.000643945621360287,0.000489485941162654,0.000337437223219893,0.000187786292874881,4.05199754704823e-05,-0.000104374903650430,-0.000246911519144991,-0.000387103045670325,-0.000524962657883568,-0.000660503530441847,-0.000793738838002295,-0.000924681755222039,-0.00105334545675821,-0.00117974311726795,-0.00130388791140837,-0.00142579301383661,-0.00154547159920980,-0.00166293684218508,-0.00177820191741956,-0.00189127999957039,-0.00200218426329469,-0.00211092788324959,-0.00221752403409223,-0.00232198589047973,-0.00242432662706922,-0.00252455941851784,-0.00262269743948272,-0.00271875386462098,-0.00281274186858975,-0.00290467462604618,-0.00299456531164737,-0.00308242710005048,-0.00316827316591263,-0.00325211668389094,-0.00333397082864255,-0.00341384877482460,-0.00349176369709420,-0.00356772877010849,-0.00364175716852460,-0.00371386206699967,-0.00378405664019081,-0.00385235406275517,-0.00391876750934987,-0.00398331015463205,-0.00404599517325882,-0.00410683573988734,-0.00416584502917471,-0.00422303621577809,-0.00427842247435458,-0.00433201697956134,-0.00438383290605548,-0.00443388342849414,-0.00448218172153444,-0.00452874095983352,-0.00457357431804852,-0.00461669497083654,-0.00465811609285474,-0.00469785085876024,-0.00473591244321017,-0.00477231402086166,-0.00480706876637184,-0.00484018985439784,-0.00487169045959680,-0.00490158375662584,-0.00492988292014209,-0.00495660112480268,-0.00498175154526475,-0.00500534735618542,-0.00502740173222183,-0.00504792784803110,-0.00506693887827037,-0.00508444799759676,-0.00510046838066742,-0.00511501320213946,-0.00512809563667001,-0.00513972885891622,-0.00514992604353520,-0.00515870036518410,-0.00516606499852003,-0.00517203311820013,-0.00517661789888154,-0.00517983251522137,-0.00518169014187677,-0.00518220395350486,-0.00518138712476277,-0.00517925283030763,-0.00517581424479658,-0.00517108454288674,-0.00516507689923525,-0.00515780448849923,-0.00514928048533581,-0.00513951806440213,-0.00512853040035532,-0.00511633066785251,-0.00510293204155082,-0.00508834769610739,-0.00507259080617934,-0.00505567454642382,-0.00503761209149795,-0.00501841661605885,-0.00499810129476366,-0.00497667930226952,-0.00495416381323355,-0.00493056800231287,-0.00490590504416463,-0.00488018811344596,-0.00485343038481397,-0.00482564503292581,-0.00479684523243860,-0.00476704415800948,-0.00473625498429557,-0.00470449088595400,-0.00467176503764191,-0.00463809061401643,-0.00460348078973469,-0.00456794873945381,-0.00453150763783093,-0.00449417065952317,-0.00445595097918768,-0.00441686177148157,-0.00437691621106199,-0.00433612747258605,-0.00429450873071090,-0.00425207316009365,-0.00420883393539145,-0.00416480423126141,-0.00411999722236068,-0.00407442608334639,-0.00402810398887565,-0.00398104411360561,-0.00393325963219340,-0.00388476371929614,-0.00383556954957096,-0.00378569029767500,-0.00373513913826538,-0.00368392924599925,-0.00363207379553371,-0.00357958596152592,-0.00352647891863299,-0.00347276584151207,-0.00341845990482027,-0.00336357428321473,-0.00330812215135258,-0.00325211668389095,-0.00319557105548697,-0.00313849844079777,-0.00308091201448049,-0.00302282495119224,-0.00296425042559017,-0.00290520161233140,-0.00284569168607307,-0.00278573382147230,-0.00272534119318622,-0.00266452697587197,-0.00260330434418667,-0.00254168647278746,-0.00247968653633147,-0.00241731770947582,-0.00235459316687765,-0.00229152608319409,-0.00222812963308227,-0.00216441699119931,-0.00210040133220236,-0.00203609583074853,-0.00197151366149497,-0.00190666799909879,-0.00184157201821714,-0.00177623889350714,-0.00171068179962591,-0.00164491391123061,-0.00157894840297834,-0.00151279844952625,-0.00144647722553146,-0.00137999790565111,-0.00131337366454232,-0.00124661767686223,-0.00117974311726796,-0.00111276316041665,-0.00104569098096542,-0.000978539753571414,-0.000911322652891754,-0.000844052853583573,-0.000776743530303999,-0.000709407857710165,-0.000642059010459201,-0.000574710163208236,-0.000507374490614402,-0.000440065167334829,-0.000372795368026647,-0.000305578267346987,-0.000238427039952979,-0.000171354860501754,-0.000104374903650443,-3.75003440561753e-05,2.92556436239182e-05,9.58798847327070e-05,0.000162359204613060,0.000228680428607848,0.000294830382059940,0.000360795890312205,0.000426563778707513,0.000492120872588734,0.000557453997298737,0.000622549978180391,0.000687395640576566,0.000751977809830132,0.000816283311283958,0.000880298970280914,0.000944011612163869,0.00100740806227569,0.00107047514595925,0.00113319968855742,0.00119556851541307,0.00125756845186906,0.00131918632326827,0.00138040895495357,0.00144122317226782,0.00150161580055390,0.00156157366515467,0.00162108359141300,0.00168013240467177,0.00173870693027384,0.00179679399356209,0.00185438041987937,0.00191145303456857,0.00196799866297255,0.00202400413043418,0.00207945626229633,0.00213434188390187,0.00218864782059367,0.00224236089771460,0.00229546794060752,0.00234795577461532,0.00239981122508085,0.00245102111734699,0.00250157227675660,0.00255145152865256,0.00260064569837774,0.00264914161127500,0.00269692609268722,0.00274398596795726,0.00279030806242799,0.00283587920144229,0.00288068621034302,0.00292471591447305,0.00296795513917525,0.00301039070979250,0.00305200945166765,0.00309279819014359,0.00313274375056318,0.00317183295826928,0.00321005263860478,0.00324738961691253,0.00328383071853541,0.00331936276881629,0.00335397259309804,0.00338764701672352,0.00342037286503561,0.00345213696337717,0.00348292613709108,0.00351272721152020,0.00354152701200741,0.00356931236389558,0.00359607009252756,0.00362178702324624,0.00364644998139448,0.00367004579231515,0.00369256128135113,0.00371398327384527,0.00373429859514046,0.00375349407057955,0.00377155652550543,0.00378847278526095,0.00380422967518899,0.00381881402063243,0.00383221264693411,0.00384441237943693,0.00385540004348374,0.00386516246441742,0.00387368646758084,0.00388095887831686,0.00388696652196835,0.00389169622387819,0.00389513480938924,0.00389726910384438,0.00389808593258647,0.00389757212095838,0.00389571449430298,0.00389249987796315,0.00388791509728175,0.00388194697760164,0.00387458234426571,0.00386580802261682,0.00385561083799783,0.00384397761575163,0.00383089518122107,0.00381635035974903,0.00380032997667838,0.00378282085735199,0.00376380982711272,0.00374328371130344,0.00372122933526704,0.00369763352434636,0.00367248310388430,0.00364576489922370,0.00361746573570745,0.00358757243867842,0.00355607183347946,0.00352295074545346,0.00348819599994328,0.00345179442229179,0.00341373283784186,0.00337399807193636,0.00333257694991816,0.00328945629713013,0.00324462293891514,0.00319806370061606,0.00314976540757576,0.00309971488513710,0.00304789895864296,0.00299430445343621,0.00293891819485971,0.00288172700825634,0.00282271771896896,0.00276187715234045,0.00269919213371367,0.00263464948843150,0.00256823604183680,0.00249993861927244,0.00242974404608129,0.00235763914760623,0.00228361074919011,0.00220764567617583,0.00212973075390622,0.00204985280772418,0.00196799866297257,0.00188415514499425,0.00179830907913211,0.00171044729072901,0.00162055660512780,0.00152862384767138,0.00143463584370260,0.00133857941856435,0.00124044139759948,0.00114020860615086,0.00103786786956136,0.000933406013173866,0.000826809862331229,0.000718066242376327,0.000607161978652026,0.000494083896501199,0.000378818821266717,0.000261353578291441,0.000141674992918246,1.97698904900075e-05,-0.000104374903650416,-0.000230772564160150,-0.000359436265696324,-0.000490379182916067,-0.000623614490476515,-0.000759155363034794,-0.000897014975248033,-0.00103720650177337,-0.00117974311726793,-0.00132463799638884,-0.00147190431379324,-0.00162155524413825,-0.00177360396208101,-0.00192806364227864,-0.00208494745938829,-0.00224426858806706,-0.00240604020297211,-0.00257027547876055,-0.00273698759008952,-0.00290618971161615,-0.00307789501799758,-0.00325211668389092,-0.00342886788395331,-0.00360816179284188,-0.00379001158521376,-0.00397443043572609,-0.00416143151903598,-0.00435102800980058,-0.00454323308267701,-0.00473805991232240,-0.00493552167339389,-0.00513563154054861,-0.00533840268844368,-0.00554384829173624,-0.00575198152508340,-0.00596281556314232,-0.00617636358057011,-0.00639263875202392,-0.00661165425216086,-0.00683342325563806,-0.00705795893711267,-0.00728527447124180,-0.00751538303268260,-0.00774829779609218
    };
    private double[] spob = new double[]{
            0.000104203710062145,9.92251831032773e-05,9.30005495392760e-05,8.55990000890085e-05,7.71105220023823e-05,6.76448949086332e-05,5.73303346231694e-05,4.63117997475190e-05,3.47489818778761e-05,2.28140059934579e-05,1.06888730245539e-05,-1.43731839652774e-06,-1.33713295135227e-05,-2.49188729846011e-05,-3.58877898139386e-05,-4.60912606601471e-05,-5.53509988618667e-05,-6.35003717265631e-05,-7.03873967139063e-05,-7.58775601257148e-05,-7.98564077916321e-05,-8.22318599994886e-05,-8.29362065326468e-05,-8.19277420995790e-05,-7.91920076151641e-05,-7.47426086465068e-05,-6.86215887837017e-05,-6.08993426414069e-05,-5.16740605337722e-05,-4.10707044780526e-05,-2.92395229492283e-05,-1.63541196023997e-05,-2.60909887197970e-06,1.17826811832799e-05,2.65932113216573e-05,4.15827447658107e-05,5.65034719685857e-05,7.11034011194541e-05,8.51303845416301e-05,9.83362275655447e-05,0.000110480813883832,0.000121336179857406,0.000130690469796098,0.000138351704908415,0.000144151300412164,0.000147947268212079,0.000149627046553763,0.000149109903108957,0.000146348863970275,0.000141332127952138,0.000134083933310143,0.000124664852390044,0.000113171498673194,9.97356400594560e-05,8.45227218736081e-05,6.77298128426261e-05,4.95829970095910e-05,3.03342440641124e-05,1.02577997183871e-05,-1.03538536151064e-05,-3.11944076351479e-05,-5.19484451070444e-05,-7.22963914283324e-05,-9.19196241507740e-05,-0.000110505659853569,-0.000127753335066740,-0.000143377896568791,-0.000157115916374076,-0.000168729948106555,-0.000178012844228446,-0.000184791657733048,-0.000188931057375607,-0.000190336192237207,-0.000188954949304957,-0.000184779556697378,-0.000177847495037524,-0.000168241690131590,-0.000156089971385606,-0.000141563792112644,-0.000124876219862924,-0.000106279216957062,-8.60602433221830e-05,-6.45382253240978e-05,-4.20589453609811e-05,-1.89899173450061e-05,4.28517733304332e-06,2.73724103547921e-05,4.98737933500875e-05,7.13936350716934e-05,9.15449684798123e-05,0.000109955944550880,0.000126276088466818,0.000140182314365500,0.000151384597059555,0.000159631203049204,0.000164713388728931,0.000166469480852405,0.000164788262983804,0.000159611601708447,0.000150936257659737,0.000138814838777840,0.000123355866463857,0.000104722939229179,8.31329928468661e-05,5.88536706626142e-05,3.21998323822715e-05,3.52924408212501e-06,-2.67624938514458e-05,-5.82477108893800e-05,-9.04730403442168e-05,-0.000122966309699654,-0.000155243843977407,-0.000186818070522727,-0.000217205306963429,-0.000245933609288774,-0.000272550554109644,-0.000296630828276544,-0.000317783500191699,-0.000335658850368067,-0.000349954644040033,-0.000360421735863682,-0.000366868905870567,-0.000369166836738477,-0.000367251154965082,-0.000361124472496561,-0.000350857380568128,-0.000336588363728387,-0.000318522618996550,-0.000296929782576498,-0.000272140584248325,-0.000244542467192570,-0.000214574228287978,-0.000182719750574715,-0.000149500915312420,-0.000115469795617642,-8.12002467850800e-05,-4.72790198478090e-05,-1.42965345037501e-05,1.71625449535211e-05,4.65287817633712e-05,7.32573349823302e-05,9.68370714649492e-05,0.000116799270983127,0.000132725778287391,0.000144256462700621,0.000151095854972332,0.000153018842495376,0.000149875317445123,0.000141593687755545,0.000128183177876196,0.000109734864707080,8.64214137068146e-05,5.84955006128219e-05,2.62869251819240e-05,-9.80155547559847e-06,-4.92996253749898e-05,-9.16759708208662e-05,-0.000136345915417472,-0.000182680021530673,-0.000230013533720875,-0.000277656524346119,-0.000324904588253026,-0.000371049922472823,-0.000415392618329202,-0.000457251987516722,-0.000495977740653716,-0.000530960836640056,-0.000561643823900617,-0.000587530500265481,-0.000608194726776758,-0.000623288242021108,-0.000632547337522325,-0.000635798271101084,-0.000632961313688611,-0.000624053345598399,-0.000609188940411016,-0.000588579898076914,-0.000562533213230963,-0.000531447489660101,-0.000495807836977872,-0.000456179310434671,-0.000413198979026404,-0.000367566730258620,-0.000320034941690007,-0.000271397169349896,-0.000222476020952612,-0.000174110397202394,-0.000127142297115452,-8.24033929409777e-05,-4.07015867453060e-05,-2.80776388669543e-06,3.05570416433227e-05,5.87338587431504e-05,8.11371634693348e-05,9.72652424527525e-05,0.000106709355636516,0.000109161535350761,0.000104420878421070,9.23982102506404e-05,7.31190242978085e-05,4.67246267265851e-05,1.34714438397416e-05,-2.62715212157203e-05,-7.20270665019816e-05,-0.000123215958522200,-0.000179164813778542,-0.000239115591347642,-0.000302236565989789,-0.000367634625868106,-0.000434368715679348,-0.000501464225290517,-0.000567928106200322,-0.000632764483625553,-0.000694990521023746,-0.000753652286628037,-0.000807840368251706,-0.000856704983322827,-0.000899470335874259,-0.000935447981016918,-0.000964048970176044,-0.000984794566917327,-0.000997325343316264,-0.00100140849025334,-0.000996943201416916,-0.000983964019780317,-0.000962642066458163,-0.000933284104669411,-0.000896329425535637,-0.000852344577094735,-0.000802015992665356,-0.000746140609001502,-0.000685614597974770,-0.000621420367268623,-0.000554612015236329,-0.000486299452161858,-0.000417631424203961,-0.000349777696875503,-0.000283910671639414,-0.000221186721773462,-0.000162727541814464,-0.000109601808452837,-6.28074495946673e-05,-2.32548124004425e-05,8.24898951872285e-06,3.10142848052242e-05,4.44813636801571e-05,4.82310864398295e-05,4.19933873413008e-05,2.56535112067320e-05,-7.44145820639459e-07,-3.69946833490108e-05,-8.27338851009581e-05,-0.000137441962170268,-0.000200449824196418,-0.000270947810818791,-0.000347996775676068,-0.000430541376332454,-0.000517425386476276,-0.000607408812162429,-0.000699186562340218,-0.000791408395963509,-0.000882699844110594,-0.000971683786179427,-0.00105700234473329,-0.00113733875424584,-0.00121143885504474,-0.00127813186531039,-0.00133635009109382,-0.00138514724693235,-0.00142371507762947,-0.00145139799490827,-0.00146770547064006,-0.00147232196080644,-0.00146511417081312,-0.00144613551270543,-0.00141562764764731,-0.00137401905207072,-0.00132192059249275,-0.00126011814140998,-0.00118956231417026,-0.00111135545353599,-0.00102673603403738,-0.000937060701429015,-0.000843784202894495,-0.000748437500414437,-0.000652604392294349,-0.000557896995670290,-0.000465930465371066,-0.000378297341391883,-0.000296541928087113,-0.000222135112772606,-0.000156450029589087,-0.000100738966168817,-5.61118959181985e-05,-2.35169977344504e-05,-3.72349797081117e-06,2.69286319455382e-06,-4.63852330346366e-06,-2.58746009253038e-05,-6.09533986455417e-05,-0.000109592192892947,-0.000171289152956297,-0.000245328488122626,-0.000330789059465015,-0.000426556363742279,-0.000531337742189967,-0.000643680613948716,-0.000761993483352565,-0.000884569423118956,-0.00100961169243254,-0.00113526111073089,-0.00125962477534606,-0.00138080568461942,-0.00149693280818234,-0.00160619113318277,-0.00170685120962645,-0.00179729771987357,-0.00187605660674866,-0.00194182031163030,-0.00199347069811158,-0.00203009926807228,-0.00205102431487070,-0.00205580470233210,-0.00204425000766203,-0.00201642682063284,-0.00197266104958326,-0.00191353614606388,-0.00183988722342520,-0.00175279110930500,-0.00165355243682071,-0.00154368594328856,-0.00142489520745321,-0.00129904811551435,-0.00116814940170766,-0.00103431065991440,-0.000899718267873968,-0.000766599704277372,-0.000637188770633362,-0.000513690253736305,-0.000398244580350243,-0.000292893023006366,-0.000199544014367621,-0.000119941117358075,-5.56331792348331e-05,-7.94717018616007e-06,2.20358288034516e-05,3.35010677126800e-05,2.59166285914283e-05,-9.54326932801819e-07,-4.70458137025267e-05,-0.000111985964832289,-0.000195098769965011,-0.000295410646510580,-0.000411661804682765,-0.000542322291070188,-0.000685612520218692,-0.000839528030460110,-0.00100186813017181,-0.00117026803493502,-0.00134223403576451,-0.00151518118472545,-0.00168647293776265,-0.00185346215626847,-0.00201353283951497,-0.00216414194014966,-0.00230286060493888,-0.00242741418312228,-0.00253572035524813,-0.00262592475616034,-0.00269643349671356,-0.00274594202945004,-0.00277345985337232,-0.00277833061142906,-0.00276024720059505,-0.00271926158753602,-0.00265578910175112,-0.00257060706162328,-0.00246484767573635,-0.00233998525082271,-0.00219781782742536,-0.00204044345340047,-0.00187023139235261,-0.00168978864759921,-0.00150192226095520,-0.00130959791822115,-0.00111589545853522,-0.000923961941595186,-0.000736962974173759,-0.000558033034471658,-0.000390225558962991,-0.000236463570930937,-9.94916324861433e-05,1.81701076967345e-05,0.000114269020413084,0.000186859538941146,0.000234338467595453,0.000255475440825379,0.000249437984669783,0.000215810708654403,0.000154608240910082,6.62816111996329e-05,-4.82821156561830e-05,-0.000187767051201191,-0.000350442529663698,-0.000534183872674238,-0.000736499649614129,-0.000954565106488036,-0.00118526133544188,-0.00142521966145025,-0.00167087063382371,-0.00191849692950275,-0.00216428940397053,-0.00240440546526388,-0.00263502889807239,-0.00285243022920416,-0.00305302670349530,-0.00323344093108075,-0.00339055727315322,-0.00352157505402358,-0.00362405772234928,-0.00369597713348425,-0.00373575218747375,-0.00374228113250303,-0.00371496693064059,-0.00365373518033066,-0.00355904419694438,-0.00343188696729411,-0.00327378481471152,-0.00308677273633067,-0.00287337650175880,-0.00263658173044775,-0.00237979529185532,-0.00210679949595467,-0.00182169965988470,-0.00152886574765633,-0.00123286888204760,-0.000938413619446420,-0.000650266957888542,-0.000373185114501691,-0.000111839159804996,0.000129259368170148,0.000345831727948491,0.000533902972883802,0.000689869554969992,0.000810562438184965,0.000893304675134082,0.000935962467151462,0.000936988810280329,0.000895458926690738,0.000811096791871123,0.000684292190893424,0.000516107870542336,0.000308276496278277,6.31872718769359e-05,-0.000216137766967235,-0.000526077617990341,-0.000862456013718357,-0.00122059448228940,-0.00159537414216352,-0.00198130546297486,-0.00237260509168575,-0.00276327872129225,-0.00314720887058189,-0.00351824634966605,-0.00387030410881542,-0.00419745210890909,-0.00449401181171325,-0.00475464886811567,-0.00497446258295801,-0.00514907075653587,-0.00527468854518116,-0.00534820004630148,-0.00536722139622051,-0.00533015427123426,-0.00523622880227423,-0.00508553504997369,-0.00487904233803546,-0.00461860590662747,-0.00430696052190504,-0.00394770086031190,-0.00354524867453332,-0.00310480693923326,-0.00263230136629776,-0.00213430986847849,-0.00161798073433485,-0.00109094045349828,-0.000561192296894687,-3.70069091425264e-05,0.000473193692468066,0.000960957198389730,0.00141792555249881,0.00183596127003017,0.00220727377850011,0.00252454399984449,0.00278104538402686,0.00297075962138716,0.00308848530310739,0.00312993786611897,0.00309183924996309,0.00297199580758898,0.00276936314854552,0.00248409674987433,0.00211758734532808,0.00167248029511730,0.00115267834377980,0.000563327390297216,-8.92148806041816e-05,-0.000797427426939751,-0.00155269102645048,-0.00234536965953710,-0.00316490732853319,-0.00399993932400301,-0.00483841673950420,-0.00566774284045005,-0.00647491971316683,-0.00724670345960037,-0.00796976606377454,-0.00863086194016888,-0.00921699708348384,-0.00971559867529200,-0.0101146829669718,-0.0104030192508523,-0.0105702877530454,-0.0106072293319978,-0.0105057849459418,-0.0102592229593773,-0.00986225249227115,-0.00931112117427768,-0.00860369584804255,-0.00773952496832082,-0.00671988166468174,-0.00554778667218234,-0.00422801058353946,-0.00276705513479044,-0.00117311350083978,0.000543990155827838,0.00237288137415210,0.00430073555084474,0.00631339654051282,0.00839551243426005,0.0105306870244634,0.0127016452542219,0.0148904107614343,0.0170784934621727,0.0192470849782742,0.0213772596018237,0.0234501784060577,0.0254472940593776,0.0273505538774563,0.0291425986582321,0.0308069548859077,0.0323282179624554,0.0336922242277196,0.0348862096607500,0.0358989533138305,0.0367209037147828,0.0373442866801585,0.0377631932092212,0.0379736463732226,0.0379736463732226,0.0377631932092212,0.0373442866801585,0.0367209037147828,0.0358989533138305,0.0348862096607500,0.0336922242277196,0.0323282179624554,0.0308069548859077,0.0291425986582321,0.0273505538774563,0.0254472940593776,0.0234501784060577,0.0213772596018237,0.0192470849782742,0.0170784934621727,0.0148904107614343,0.0127016452542219,0.0105306870244634,0.00839551243426005,0.00631339654051282,0.00430073555084474,0.00237288137415210,0.000543990155827838,-0.00117311350083978,-0.00276705513479044,-0.00422801058353946,-0.00554778667218234,-0.00671988166468174,-0.00773952496832082,-0.00860369584804255,-0.00931112117427768,-0.00986225249227115,-0.0102592229593773,-0.0105057849459418,-0.0106072293319978,-0.0105702877530454,-0.0104030192508523,-0.0101146829669718,-0.00971559867529200,-0.00921699708348384,-0.00863086194016888,-0.00796976606377454,-0.00724670345960037,-0.00647491971316683,-0.00566774284045005,-0.00483841673950420,-0.00399993932400301,-0.00316490732853319,-0.00234536965953710,-0.00155269102645048,-0.000797427426939751,-8.92148806041816e-05,0.000563327390297216,0.00115267834377980,0.00167248029511730,0.00211758734532808,0.00248409674987433,0.00276936314854552,0.00297199580758898,0.00309183924996309,0.00312993786611897,0.00308848530310739,0.00297075962138716,0.00278104538402686,0.00252454399984449,0.00220727377850011,0.00183596127003017,0.00141792555249881,0.000960957198389730,0.000473193692468066,-3.70069091425264e-05,-0.000561192296894687,-0.00109094045349828,-0.00161798073433485,-0.00213430986847849,-0.00263230136629776,-0.00310480693923326,-0.00354524867453332,-0.00394770086031190,-0.00430696052190504,-0.00461860590662747,-0.00487904233803546,-0.00508553504997369,-0.00523622880227423,-0.00533015427123426,-0.00536722139622051,-0.00534820004630148,-0.00527468854518116,-0.00514907075653587,-0.00497446258295801,-0.00475464886811567,-0.00449401181171325,-0.00419745210890909,-0.00387030410881542,-0.00351824634966605,-0.00314720887058189,-0.00276327872129225,-0.00237260509168575,-0.00198130546297486,-0.00159537414216352,-0.00122059448228940,-0.000862456013718357,-0.000526077617990341,-0.000216137766967235,6.31872718769359e-05,0.000308276496278277,0.000516107870542336,0.000684292190893424,0.000811096791871123,0.000895458926690738,0.000936988810280329,0.000935962467151462,0.000893304675134082,0.000810562438184965,0.000689869554969992,0.000533902972883802,0.000345831727948491,0.000129259368170148,-0.000111839159804996,-0.000373185114501691,-0.000650266957888542,-0.000938413619446420,-0.00123286888204760,-0.00152886574765633,-0.00182169965988470,-0.00210679949595467,-0.00237979529185532,-0.00263658173044775,-0.00287337650175880,-0.00308677273633067,-0.00327378481471152,-0.00343188696729411,-0.00355904419694438,-0.00365373518033066,-0.00371496693064059,-0.00374228113250303,-0.00373575218747375,-0.00369597713348425,-0.00362405772234928,-0.00352157505402358,-0.00339055727315322,-0.00323344093108075,-0.00305302670349530,-0.00285243022920416,-0.00263502889807239,-0.00240440546526388,-0.00216428940397053,-0.00191849692950275,-0.00167087063382371,-0.00142521966145025,-0.00118526133544188,-0.000954565106488036,-0.000736499649614129,-0.000534183872674238,-0.000350442529663698,-0.000187767051201191,-4.82821156561830e-05,6.62816111996329e-05,0.000154608240910082,0.000215810708654403,0.000249437984669783,0.000255475440825379,0.000234338467595453,0.000186859538941146,0.000114269020413084,1.81701076967345e-05,-9.94916324861433e-05,-0.000236463570930937,-0.000390225558962991,-0.000558033034471658,-0.000736962974173759,-0.000923961941595186,-0.00111589545853522,-0.00130959791822115,-0.00150192226095520,-0.00168978864759921,-0.00187023139235261,-0.00204044345340047,-0.00219781782742536,-0.00233998525082271,-0.00246484767573635,-0.00257060706162328,-0.00265578910175112,-0.00271926158753602,-0.00276024720059505,-0.00277833061142906,-0.00277345985337232,-0.00274594202945004,-0.00269643349671356,-0.00262592475616034,-0.00253572035524813,-0.00242741418312228,-0.00230286060493888,-0.00216414194014966,-0.00201353283951497,-0.00185346215626847,-0.00168647293776265,-0.00151518118472545,-0.00134223403576451,-0.00117026803493502,-0.00100186813017181,-0.000839528030460110,-0.000685612520218692,-0.000542322291070188,-0.000411661804682765,-0.000295410646510580,-0.000195098769965011,-0.000111985964832289,-4.70458137025267e-05,-9.54326932801819e-07,2.59166285914283e-05,3.35010677126800e-05,2.20358288034516e-05,-7.94717018616007e-06,-5.56331792348331e-05,-0.000119941117358075,-0.000199544014367621,-0.000292893023006366,-0.000398244580350243,-0.000513690253736305,-0.000637188770633362,-0.000766599704277372,-0.000899718267873968,-0.00103431065991440,-0.00116814940170766,-0.00129904811551435,-0.00142489520745321,-0.00154368594328856,-0.00165355243682071,-0.00175279110930500,-0.00183988722342520,-0.00191353614606388,-0.00197266104958326,-0.00201642682063284,-0.00204425000766203,-0.00205580470233210,-0.00205102431487070,-0.00203009926807228,-0.00199347069811158,-0.00194182031163030,-0.00187605660674866,-0.00179729771987357,-0.00170685120962645,-0.00160619113318277,-0.00149693280818234,-0.00138080568461942,-0.00125962477534606,-0.00113526111073089,-0.00100961169243254,-0.000884569423118956,-0.000761993483352565,-0.000643680613948716,-0.000531337742189967,-0.000426556363742279,-0.000330789059465015,-0.000245328488122626,-0.000171289152956297,-0.000109592192892947,-6.09533986455417e-05,-2.58746009253038e-05,-4.63852330346366e-06,2.69286319455382e-06,-3.72349797081117e-06,-2.35169977344504e-05,-5.61118959181985e-05,-0.000100738966168817,-0.000156450029589087,-0.000222135112772606,-0.000296541928087113,-0.000378297341391883,-0.000465930465371066,-0.000557896995670290,-0.000652604392294349,-0.000748437500414437,-0.000843784202894495,-0.000937060701429015,-0.00102673603403738,-0.00111135545353599,-0.00118956231417026,-0.00126011814140998,-0.00132192059249275,-0.00137401905207072,-0.00141562764764731,-0.00144613551270543,-0.00146511417081312,-0.00147232196080644,-0.00146770547064006,-0.00145139799490827,-0.00142371507762947,-0.00138514724693235,-0.00133635009109382,-0.00127813186531039,-0.00121143885504474,-0.00113733875424584,-0.00105700234473329,-0.000971683786179427,-0.000882699844110594,-0.000791408395963509,-0.000699186562340218,-0.000607408812162429,-0.000517425386476276,-0.000430541376332454,-0.000347996775676068,-0.000270947810818791,-0.000200449824196418,-0.000137441962170268,-8.27338851009581e-05,-3.69946833490108e-05,-7.44145820639459e-07,2.56535112067320e-05,4.19933873413008e-05,4.82310864398295e-05,4.44813636801571e-05,3.10142848052242e-05,8.24898951872285e-06,-2.32548124004425e-05,-6.28074495946673e-05,-0.000109601808452837,-0.000162727541814464,-0.000221186721773462,-0.000283910671639414,-0.000349777696875503,-0.000417631424203961,-0.000486299452161858,-0.000554612015236329,-0.000621420367268623,-0.000685614597974770,-0.000746140609001502,-0.000802015992665356,-0.000852344577094735,-0.000896329425535637,-0.000933284104669411,-0.000962642066458163,-0.000983964019780317,-0.000996943201416916,-0.00100140849025334,-0.000997325343316264,-0.000984794566917327,-0.000964048970176044,-0.000935447981016918,-0.000899470335874259,-0.000856704983322827,-0.000807840368251706,-0.000753652286628037,-0.000694990521023746,-0.000632764483625553,-0.000567928106200322,-0.000501464225290517,-0.000434368715679348,-0.000367634625868106,-0.000302236565989789,-0.000239115591347642,-0.000179164813778542,-0.000123215958522200,-7.20270665019816e-05,-2.62715212157203e-05,1.34714438397416e-05,4.67246267265851e-05,7.31190242978085e-05,9.23982102506404e-05,0.000104420878421070,0.000109161535350761,0.000106709355636516,9.72652424527525e-05,8.11371634693348e-05,5.87338587431504e-05,3.05570416433227e-05,-2.80776388669543e-06,-4.07015867453060e-05,-8.24033929409777e-05,-0.000127142297115452,-0.000174110397202394,-0.000222476020952612,-0.000271397169349896,-0.000320034941690007,-0.000367566730258620,-0.000413198979026404,-0.000456179310434671,-0.000495807836977872,-0.000531447489660101,-0.000562533213230963,-0.000588579898076914,-0.000609188940411016,-0.000624053345598399,-0.000632961313688611,-0.000635798271101084,-0.000632547337522325,-0.000623288242021108,-0.000608194726776758,-0.000587530500265481,-0.000561643823900617,-0.000530960836640056,-0.000495977740653716,-0.000457251987516722,-0.000415392618329202,-0.000371049922472823,-0.000324904588253026,-0.000277656524346119,-0.000230013533720875,-0.000182680021530673,-0.000136345915417472,-9.16759708208662e-05,-4.92996253749898e-05,-9.80155547559847e-06,2.62869251819240e-05,5.84955006128219e-05,8.64214137068146e-05,0.000109734864707080,0.000128183177876196,0.000141593687755545,0.000149875317445123,0.000153018842495376,0.000151095854972332,0.000144256462700621,0.000132725778287391,0.000116799270983127,9.68370714649492e-05,7.32573349823302e-05,4.65287817633712e-05,1.71625449535211e-05,-1.42965345037501e-05,-4.72790198478090e-05,-8.12002467850800e-05,-0.000115469795617642,-0.000149500915312420,-0.000182719750574715,-0.000214574228287978,-0.000244542467192570,-0.000272140584248325,-0.000296929782576498,-0.000318522618996550,-0.000336588363728387,-0.000350857380568128,-0.000361124472496561,-0.000367251154965082,-0.000369166836738477,-0.000366868905870567,-0.000360421735863682,-0.000349954644040033,-0.000335658850368067,-0.000317783500191699,-0.000296630828276544,-0.000272550554109644,-0.000245933609288774,-0.000217205306963429,-0.000186818070522727,-0.000155243843977407,-0.000122966309699654,-9.04730403442168e-05,-5.82477108893800e-05,-2.67624938514458e-05,3.52924408212501e-06,3.21998323822715e-05,5.88536706626142e-05,8.31329928468661e-05,0.000104722939229179,0.000123355866463857,0.000138814838777840,0.000150936257659737,0.000159611601708447,0.000164788262983804,0.000166469480852405,0.000164713388728931,0.000159631203049204,0.000151384597059555,0.000140182314365500,0.000126276088466818,0.000109955944550880,9.15449684798123e-05,7.13936350716934e-05,4.98737933500875e-05,2.73724103547921e-05,4.28517733304332e-06,-1.89899173450061e-05,-4.20589453609811e-05,-6.45382253240978e-05,-8.60602433221830e-05,-0.000106279216957062,-0.000124876219862924,-0.000141563792112644,-0.000156089971385606,-0.000168241690131590,-0.000177847495037524,-0.000184779556697378,-0.000188954949304957,-0.000190336192237207,-0.000188931057375607,-0.000184791657733048,-0.000178012844228446,-0.000168729948106555,-0.000157115916374076,-0.000143377896568791,-0.000127753335066740,-0.000110505659853569,-9.19196241507740e-05,-7.22963914283324e-05,-5.19484451070444e-05,-3.11944076351479e-05,-1.03538536151064e-05,1.02577997183871e-05,3.03342440641124e-05,4.95829970095910e-05,6.77298128426261e-05,8.45227218736081e-05,9.97356400594560e-05,0.000113171498673194,0.000124664852390044,0.000134083933310143,0.000141332127952138,0.000146348863970275,0.000149109903108957,0.000149627046553763,0.000147947268212079,0.000144151300412164,0.000138351704908415,0.000130690469796098,0.000121336179857406,0.000110480813883832,9.83362275655447e-05,8.51303845416301e-05,7.11034011194541e-05,5.65034719685857e-05,4.15827447658107e-05,2.65932113216573e-05,1.17826811832799e-05,-2.60909887197970e-06,-1.63541196023997e-05,-2.92395229492283e-05,-4.10707044780526e-05,-5.16740605337722e-05,-6.08993426414069e-05,-6.86215887837017e-05,-7.47426086465068e-05,-7.91920076151641e-05,-8.19277420995790e-05,-8.29362065326468e-05,-8.22318599994886e-05,-7.98564077916321e-05,-7.58775601257148e-05,-7.03873967139063e-05,-6.35003717265631e-05,-5.53509988618667e-05,-4.60912606601471e-05,-3.58877898139386e-05,-2.49188729846011e-05,-1.33713295135227e-05,-1.43731839652774e-06,1.06888730245539e-05,2.28140059934579e-05,3.47489818778761e-05,4.63117997475190e-05,5.73303346231694e-05,6.76448949086332e-05,7.71105220023823e-05,8.55990000890085e-05,9.30005495392760e-05,9.92251831032773e-05,0.000104203710062145
    };
    private double[] gsenb = new double[] {
            -0.00461400000883361,2.41625470177338e-18,0.0233116392163097,0.0694528102227359,0.128840076180777,0.179831609681888,0.200000000000000,0.179831609681888,0.128840076180777,
            0.0694528102227359,0.0233116392163097,2.41625470177338e-18,-0.00461400000883361
    };

    public MainController(Context context, LinkedBlockingQueue queue, LinkedBlockingQueue ecgQueue,
                          LinkedBlockingQueue gsenQueue) {
        this.context = context;
        this.spoQueue = queue;
        this.ecgQueue = ecgQueue;
        this.gsenQueue = gsenQueue;
    }

    public void onResume() {
        controllerThread = new ControllerThread();
        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(context);
        filterOn = sharedPreferences.getBoolean("filter", false);
        source = sharedPreferences.getString("data_source", "组合包1");
        initFilter();
        controllerThread.start();
    }

    public void onPause() {
        if (controllerThread != null) {
            controllerThread.running = false;
            controllerThread = null;
        }
    }

    private void initFilter() {
        try {
            FileReader fileReader = new FileReader(Environment.getExternalStorageDirectory() + "/AAA/" + "h2.txt");
            BufferedReader bufferedReader = new BufferedReader(fileReader);
            String line = bufferedReader.readLine();
            String[] str = line.split(",");
            int n = str.length;
            spob = new double[n];
            for (int i = 0; i < n; i++) {
                spob[i] = Double.parseDouble(str[i]);
            }
        }
        catch (Exception e) {

        }

        try {
            FileReader fileReader = new FileReader(Environment.getExternalStorageDirectory() + "/AAA/" + "h3.txt");
            BufferedReader bufferedReader = new BufferedReader(fileReader);
            String line = bufferedReader.readLine();
            String[] str = line.split(",");
            int n = str.length;
            gsenb = new double[n];
            for (int i = 0; i < n; i++) {
                gsenb[i] = Double.parseDouble(str[i]);
            }
        }
        catch (Exception e) {

        }

        try {
            FileReader fileReader = new FileReader(Environment.getExternalStorageDirectory() + "/AAA/" + "h1.txt");
            BufferedReader bufferedReader = new BufferedReader(fileReader);
            String line = bufferedReader.readLine();
            String[] str = line.split(",");
            int n = str.length;
            ecgb = new double[n];
            for (int i = 0; i < n; i++) {
                ecgb[i] = Double.parseDouble(str[i]);
            }
        }
        catch (Exception e) {

        }

        try {
            FileReader fileReader = new FileReader(Environment.getExternalStorageDirectory() + "/AAA/" + "b1.txt");
            BufferedReader bufferedReader = new BufferedReader(fileReader);
            String line = bufferedReader.readLine();
            String[] str = line.split(",");
            int n = str.length;
            ecgPreb = new double[n];
            for (int i = 0; i < n; i++) {
                ecgPreb[i] = Double.parseDouble(str[i]);
            }
        }
        catch (Exception e) {

        }

        try {
            FileReader fileReader = new FileReader(Environment.getExternalStorageDirectory() + "/AAA/" + "a1.txt");
            BufferedReader bufferedReader = new BufferedReader(fileReader);
            String line = bufferedReader.readLine();
            String[] str = line.split(",");
            int n = str.length;
            ecgPrea = new double[n];
            for (int i = 0; i < n; i++) {
                ecgPrea[i] = Double.parseDouble(str[i]);
            }
        }
        catch (Exception e) {

        }
    }

    private class ControllerThread extends Thread implements Runnable {
        volatile boolean running = true;

        @Override
        public void run() {
            spoQueue.clear();
            ecgQueue.clear();
            gsenQueue.clear();
            spoList = new ArrayList<>();
            ecgList = new ArrayList<>();
            gsenList = new ArrayList<>();
            ecgListEx = new ArrayList<>();

            while (ControllerThread.this.running) {
                try {
                    if (spoQueue.size() > 0) {
                        int spo = (int) spoQueue.take();
                        if (filterOn) {
                            if (source.equals("G-senso测量")) {
                                spo = firFilterGsen(spo, spoList);
                            }
                            else {
                                spo = firFilterSpo(spo);
                            }
                        }
                        BroadcastUtil.updateImpedance(context, spo);
                    }

                    if (ecgQueue.size() > 0) {
                        int ecg = (int) ecgQueue.take();
                        if (filterOn) {
                            if (source.equals("G-senso测量")) {
                                ecg = firFilterGsen(ecg, ecgList);
                                BroadcastUtil.updateECG(context, ecg);
                            }
                            else {
                                int ecgx = iirFilterEcg(ecg);
                                ecg = firFilterECG(ecgx);
                                BroadcastUtil.updateECG(context, ecgx - ecg);
                            }
                        }
                        else {
                            BroadcastUtil.updateECG(context, ecg);
                        }
                    }

                    if (gsenQueue.size() > 0) {
                        int gsen = (int) gsenQueue.take();
                        if (filterOn) {
                            gsen = firFilterGsen(gsen, gsenList);
                        }
                        BroadcastUtil.updateStrike(context, gsen);
                    }

                }
                catch (Exception e) {
                    Log.i(TAG, "controller exception!" + e.toString());
                }
            }
        }
    }

    private int iirFilterEcg(int in) {
        if (ecgListEx.size() < ecgPreb.length) {
            ecgListEx.add(in);
            ecgList.add(in);
            return in;
        }

        int out =(int) (in * ecgPreb[0]);
        int n = ecgPreb.length;
        int m = ecgList.size();
        for (int i = 1; i < n; i++) {
            out = out - (int)(ecgPrea[i] * ecgList.get(m - i));
        }
        for (int i = 1; i < n; i++) {
            out = out + (int)(ecgPreb[i] * ecgListEx.get(n - i));
        }
        ecgListEx.add(in);
        ecgListEx.remove(0);
        return out;
//        ecgList.add(out);
    }

    private int firFilterECG(int in) {
        if (ecgList.size() < ecgb.length) {
            ecgList.add(in);
            return in;
        }
        int out = 0;
        out = (int) (in * ecgb[0]);
        int n = ecgb.length;
        for (int i = 1; i < n; i++) {
            out = out + (int) (ecgb[i] * ecgList.get(n - i));
        }
        ecgList.add(in);
        ecgList.remove(0);
        return out;
    }

    private int firFilterSpo(int in) {
        if (spoList.size() < spob.length) {
            spoList.add(in);
            return in;
        }
        int out = 0;
        out = (int) (in * spob[0]);
        int n = spob.length;
        for (int i = 1; i < n; i++) {
            out = out + (int) (spob[i] * spoList.get(n - i));
        }
        spoList.add(in);
        spoList.remove(0);
        return out;
    }

    private int firFilterGsen(int in, List<Integer> list) {
        if (list.size() < gsenb.length) {
            list.add(in);
            return in;
        }
        int out = 0;
        out = (int) (in * gsenb[0]);
        int n = gsenb.length;
        for (int i = 1; i < n; i++) {
            out = out + (int) (gsenb[i] * list.get(n - i));
        }
        list.add(in);
        list.remove(0);
        return out;
    }
}
